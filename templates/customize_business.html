<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Customize Business</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='create_business.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='customize_business.css')}}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='search.css') }}">
</head>
<body>

<nav class="navbar">
  <div class="nav-logo">
    Localate <img src="{{ url_for('static', filename='cat_logo.svg') }}" alt="Localate Logo" class="nav-icon">
  </div>
  <form id="navbar-search-form" method="GET" action="{{ url_for('search.search') }}" class="navbar-search-form" role="search" autocomplete="off" style="max-width: 600px; min-width: 300px; position: relative; overflow: visible;">
    <div class="search-input-wrapper" style="position: relative; width: 200%; margin-left: -30%;">
      <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"
           style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 1em; height: 1em; color: #888;">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1112 4.5a7.5 7.5 0 014.65 12.15z"/>
      </svg>
      <input
        type="search"
        id="navbar-q"
        name="q"
        placeholder="Search for any business"
        value="{{ request.args.get('q', '') }}"
        aria-label="Search for a business or city"
        class="search-input"
        style="width: 75%; padding: 0.5em 0.5em 0.5em 2.2em; border-radius: 25px; border: none; background-color: #1e1e1e; color: #eee; font-size: 1rem;"
      />
      <ul id="navbar-autocomplete-list" class="autocomplete-suggestions hidden" style="top: 110%; left: 0; width: 75%;"></ul>
    </div>
  </form>
  <input type="checkbox" id="nav-toggle" class="nav-toggle">
  <ul class="nav-links">
    <li><a href="{{ url_for('business.index') }}"><img src="{{ url_for('static', filename='home_logo.svg') }}" alt="Home Icon" class="nav-icon-small"> Home</a></li>
    <li><a href="{{ url_for('business.dashboard') }}"><img src="{{ url_for('static', filename = 'dash_svg.svg') }}" alt ="Dash Icon" name="dash-icon" class="nav-icon-small"> Dashboard</a></li>
    <li><a href="{{ url_for('search.search') }}"><i class="fas fa-store nav-icon-small"></i> Browse</a></li>
    <li><a href="{{ url_for('auth.logout') }}"><img src="{{ url_for('static', filename = 'logout.svg') }}" alt ="Logout Icon" name="logout-icon" class="nav-icon-small"> Logout</a></li>
    <li><a href="{{ url_for('business.premium') }}"><i class="fas fa-crown nav-icon-small" style="color: #ffffff;"></i> Premium</a></li>
    <li>
      <a href="{{ url_for('business.support') }}" class="support-link" style="color: #ffffff;">
        <i class="fas fa-heart"></i> About Us
      </a>
    </li>
  </ul>
  <label for="nav-toggle" class="nav-toggle-label">
    <span></span>
  </label>
</nav>

<main class="create-business-container">
  <h2>Customize Your Business Page</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <ul class="flash-messages">
        {% for category, message in messages %}
          <li class="flash-{{ category }}">{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

  <form method="POST" class="create-business-form">

    {% set colors = [
        ("White","#FFFFFF"), ("Warm Beige","#FDF4E7"), ("Peach","#FFDAB9"), ("Soft Gray","#F3F4F6"),
        ("Slate Gray","#64748B"), ("Charcoal","#1F2937"), ("Dark Slate","#2F4F4F"), ("Black","#000000"),
        ("Coffee Brown","#451A03"), ("Deep Navy","#1E293B"), ("Electric Blue","#007FFF"), ("Ocean Blue","#3B82F6"),
        ("Sky Blue","#0EA5E9"), ("Turquoise","#40E0D0"), ("Cyan","#00FFFF"), ("Deep Blue","#1E40AF"),
        ("Teal","#008080"), ("Mint Green","#06D6A0"), ("Emerald Green","#10B981"), ("Forest Green","#14532D"),
        ("Lime Green","#32CD32"), ("Olive","#808000"), ("Coral Red","#EF4444"), ("Bright Red","#FF0000"),
        ("Ruby Red","#DC2626"), ("Rose Pink","#EC4899"), ("Deep Pink","#FF1493"), ("Magenta","#FF00FF"),
        ("Royal Purple","#8B5CF6"), ("Lavender","#A855F7"), ("Orchid","#DA70D6"), ("Indigo","#4B0082"),
        ("Golden Yellow","#EAB308"), ("Sunset Orange","#F59E0B"), ("Amber","#FFBF00"), ("Orange","#FFA500")
    ] %}

      <div class="color-section">
      <label>Background Color</label>
      <div class="color-controls">
        <button type="button" class="default-btn" data-target="card_background">Default</button>
        <button type="button" class="custom-color-btn" data-target="card_background"><span>ðŸŽ¨</span> Custom Color</button>
        <button type="button" class="gradient-toggle-btn" data-target="card_background">
          ðŸŒˆ Gradient: <strong class="state">OFF</strong>
        </button>
      </div>
      <div class="color-picker" id="card_background_picker">
        {% for color, hex in colors %}
        <div class="color-option {% if business.card_background == hex %}selected{% endif %}"
             style="background: linear-gradient(to bottom, {{ hex }} 0%, {{ hex }}CC 100%);"
             data-value="{{ hex }}" title="{{ color }}"></div>
        {% endfor %}
      </div>
      <div class="custom-color-display" id="card_background_custom" style="display: none;">
        <div class="selected-color-preview" data-target="card_background">
          <div class="color-preview-swatch" style="background-color: #000000;"></div>
          <span class="selected-color-label">Selected Color</span>
        </div>
        <input type="color" class="hidden-color-input" data-target="card_background" value="#000000">
      </div>
      <input type="hidden" name="card_background" id="card_background" value="{{ business.card_background or '' }}">
      <input type="hidden" name="card_background_gradient" id="card_background_gradient" value="{{ business.card_background_gradient or '' }}">
    </div>

    <div class="color-section">
      <label>Info Cards Color</label>
      <div class="color-controls">
        <button type="button" class="default-btn" data-target="small_card_bg">Default</button>
        <button type="button" class="custom-color-btn" data-target="small_card_bg"><span>ðŸŽ¨</span> Custom Color</button>
        <button type="button" class="gradient-toggle-btn" data-target="small_card_bg">
          ðŸŒˆ Gradient: <strong class="state">OFF</strong>
        </button>
      </div>
      <div class="color-picker" id="small_card_bg_picker">
        {% for color, hex in colors %}
        <div class="color-option {% if business.small_card_bg == hex %}selected{% endif %}"
             style="background: linear-gradient(to bottom, {{ hex }} 0%, {{ hex }}CC 100%);"
             data-value="{{ hex }}" title="{{ color }}"></div>
        {% endfor %}
      </div>
      <div class="custom-color-display" id="small_card_bg_custom" style="display: none;">
        <div class="selected-color-preview" data-target="small_card_bg">
          <div class="color-preview-swatch" style="background-color: #000000;"></div>
          <span class="selected-color-label">Selected Color</span>
        </div>
        <input type="color" class="hidden-color-input" data-target="small_card_bg" value="#000000">
      </div>
      <input type="hidden" name="small_card_bg" id="small_card_bg" value="{{ business.small_card_bg or '' }}">
      <input type="hidden" name="small_card_bg_gradient" id="small_card_bg_gradient" value="{{ business.small_card_bg_gradient or '' }}">
    </div>

    <div class="color-section">
      <label>Button Color</label>
      <div class="color-controls">
        <button type="button" class="default-btn" data-target="button_color">Default</button>
        <button type="button" class="custom-color-btn" data-target="button_color"><span>ðŸŽ¨</span> Custom Color</button>
        <button type="button" class="gradient-toggle-btn" data-target="button_color">
          ðŸŒˆ Gradient: <strong class="state">OFF</strong>
        </button>
      </div>
      <div class="color-picker" id="button_color_picker">
        {% for color, hex in colors %}
        <div class="color-option {% if business.button_color == hex %}selected{% endif %}"
             style="background: linear-gradient(to bottom, {{ hex }} 0%, {{ hex }}CC 100%);"
             data-value="{{ hex }}" title="{{ color }}"></div>
        {% endfor %}
      </div>
      <div class="custom-color-display" id="button_color_custom" style="display: none;">
        <div class="selected-color-preview" data-target="button_color">
          <div class="color-preview-swatch" style="background-color: #000000;"></div>
          <span class="selected-color-label">Selected Color</span>
        </div>
        <input type="color" class="hidden-color-input" data-target="button_color" value="#000000">
      </div>
      <input type="hidden" name="button_color" id="button_color" value="{{ business.button_color or '' }}">
      <input type="hidden" name="button_color_gradient" id="button_color_gradient" value="{{ business.button_color_gradient or '' }}">
    </div>

    <div class="color-section">
      <label>Text Color</label>
      <div class="color-controls">
        <button type="button" class="default-btn" data-target="text_color">Default</button>
        <button type="button" class="custom-color-btn" data-target="text_color"><span>ðŸŽ¨</span> Custom Color</button>
      </div>
      <div class="color-picker" id="text_color_picker">
        {% for color, hex in colors %}
        <div class="color-option {% if business.text_color == hex %}selected{% endif %}"
             style="background: linear-gradient(to bottom, {{ hex }} 0%, {{ hex }}CC 100%);"
             data-value="{{ hex }}" title="{{ color }}"></div>
        {% endfor %}
      </div>
      <div class="custom-color-display" id="text_color_custom" style="display: none;">
        <div class="selected-color-preview" data-target="text_color">
          <div class="color-preview-swatch" style="background-color: #000000;"></div>
          <span class="selected-color-label">Selected Color</span>
        </div>
        <input type="color" class="hidden-color-input" data-target="text_color" value="#000000">
      </div>
      <input type="hidden" name="text_color" id="text_color" value="{{ business.text_color or '' }}">
      <input type="hidden" name="text_color_gradient" id="text_color_gradient" value="{{ business.text_color_gradient or '' }}">
    </div>

    <div>
      <label for="font_family">Font</label>
      <select name="font_family" id="font_family">
        <option value="" {% if not business.font_family %}selected{% endif %}>Default</option>
        {% for font in [
            "Inter, system-ui, sans-serif", "Roboto, Arial, sans-serif", "Open Sans, sans-serif",
            "Lato, sans-serif", "Poppins, sans-serif", "Montserrat, sans-serif",
            "Source Sans Pro, sans-serif", "Nunito Sans, sans-serif", "Work Sans, sans-serif",
            "Raleway, sans-serif", "Oswald, sans-serif", "Ubuntu, sans-serif",
            "Fira Sans, sans-serif", "Cabin, sans-serif", "Muli, sans-serif",
            "Quicksand, sans-serif", "Exo 2, sans-serif", "Hind, sans-serif",
            "Josefin Sans, sans-serif", "Karla, sans-serif",
            "Playfair Display, serif", "Merriweather, serif", "Crimson Text, serif",
            "Arvo, serif", "Bitter, serif", "Vollkorn, serif",
            "PT Serif, serif", "Georgia, serif", "Times New Roman, serif",
            "Libre Baskerville, serif", "Cormorant Garamond, serif", "Cardo, serif",
            "Courier New, monospace", "Fira Code, monospace", "Roboto Mono, monospace",
            "Inconsolata, monospace", "Source Code Pro, monospace", "IBM Plex Mono, monospace",
            "Pacifico, cursive", "Dancing Script, cursive", "Lobster, cursive",
            "Comic Neue, cursive", "Amatic SC, cursive", "Great Vibes, cursive",
            "Sacramento, cursive", "Satisfy, cursive", "Kaushan Script, cursive"
        ] %}
        <option value="{{ font }}" style="font-family: {{ font }}" {% if business.font_family == font %}selected{% endif %}>
          {{ font.split(',')[0] }}
        </option>
        {% endfor %}
      </select>
    </div>

    <button type="submit" class="btn save-btn">Save</button>
  </form>

  <a href="{{ url_for('business.view_business', business_id=business.id) }}" class="btn secondary">Back</a>
</main>

<script>
document.addEventListener('DOMContentLoaded', function () {

  const isGradientString = (v) => typeof v === 'string' && v.trim().startsWith('linear-gradient');
  const extractFirstHex = (v) => {
    if (!v) return null;
    const m = v.match(/#([0-9a-fA-F]{6})/);
    return m ? ('#' + m[1]).toUpperCase() : null;
  };

  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
  
  function createGradient(baseColor) {
    if (isGradientString(baseColor)) {
      return baseColor;
    }
    
    const hex = baseColor.replace('#', '');
    if (hex.length !== 6) return baseColor;
    const r = parseInt(hex.substr(0, 2), 16);
    const g = parseInt(hex.substr(2, 2), 16);
    const b = parseInt(hex.substr(4, 2), 16);
    const lighter = `#${clamp(r+40,0,255).toString(16).padStart(2,'0')}${clamp(g+40,0,255).toString(16).padStart(2,'0')}${clamp(b+40,0,255).toString(16).padStart(2,'0')}`;
    const darker  = `#${clamp(r-30,0,255).toString(16).padStart(2,'0')}${clamp(g-30,0,255).toString(16).padStart(2,'0')}${clamp(b-30,0,255).toString(16).padStart(2,'0')}`;
    return `linear-gradient(135deg, ${lighter} 0%, ${baseColor} 50%, ${darker} 100%)`;
  }
  function setHiddenValue(target, baseColor, useGradient) {
    const mainInput = document.getElementById(target);
    const gradInput = document.getElementById(target + '_gradient');
    
    const actualBaseColor = isGradientString(baseColor) ? extractFirstHex(baseColor) : baseColor;

    if (actualBaseColor && actualBaseColor.startsWith('#')) {
      mainInput.dataset.baseColor = actualBaseColor;
    }
    
    if (useGradient && actualBaseColor) {
      mainInput.value = actualBaseColor; 
      gradInput.value = 'true';
    } else {
      mainInput.value = actualBaseColor;
      gradInput.value = '';
    }
  }

  function updatePreview(target, baseColor, useGradient) {
    const customDisplay = document.getElementById(target + '_custom');
    const swatch = customDisplay?.querySelector('.color-preview-swatch');
    if (!swatch) return;

    const actualBaseColor = isGradientString(baseColor) ? extractFirstHex(baseColor) : baseColor;
    
    if (useGradient && actualBaseColor) {
      swatch.style.background = createGradient(actualBaseColor);
    } else if (actualBaseColor) {
      swatch.style.background = actualBaseColor;
      swatch.style.backgroundColor = actualBaseColor;
    } else {
      swatch.style.background = '';
      swatch.style.backgroundColor = '';
    }
  }

  function markGradientButton(target, on) {
    const btn = document.querySelector('.gradient-toggle-btn[data-target="' + target + '"]');
    if (!btn) return;
    const state = btn.querySelector('.state');
    if (on) {
      btn.classList.add('active');
      if (state) state.textContent = 'ON';
    } else {
      btn.classList.remove('active');
      if (state) state.textContent = 'OFF';
    }
  }

  function showCustomArea(target) {
    const custom = document.getElementById(target + '_custom');
    if (custom) custom.style.display = 'block';
    const parent = document.getElementById(target + '_picker')?.parentElement;
    const customBtn = parent?.querySelector('.custom-color-btn[data-target="' + target + '"]');
    if (customBtn) customBtn.classList.add('active');
  }

  // FIXED: Always return pure base color, never a gradient + debug logging
  function getBaseColor(target, fallback = '#000000') {
    const mainInput = document.getElementById(target);
    
    // First: Check stored base color (most reliable)
    if (mainInput.dataset.baseColor && mainInput.dataset.baseColor.startsWith('#') && !isGradientString(mainInput.dataset.baseColor)) {
      console.log(`[${target}] Using stored base color: ${mainInput.dataset.baseColor}`);
      return mainInput.dataset.baseColor;
    }
    
    // Second: Extract from gradient if present
    if (isGradientString(mainInput.value)) {
      const extracted = extractFirstHex(mainInput.value);
      console.log(`[${target}] Extracted from gradient: ${extracted} (from ${mainInput.value})`);
      if (extracted) {
        mainInput.dataset.baseColor = extracted;
        return extracted;
      }
    }
    
    // Third: Use direct color value
    if (mainInput.value && mainInput.value.startsWith('#') && !isGradientString(mainInput.value)) {
      console.log(`[${target}] Using direct color: ${mainInput.value}`);
      mainInput.dataset.baseColor = mainInput.value;
      return mainInput.value;
    }
    
    console.log(`[${target}] Using fallback: ${fallback}`);
    return fallback;
  }

  function triggerMobileColorPicker(target, currentColor) {
    const tempInput = document.createElement('input');
    tempInput.type = 'color';
    tempInput.value = currentColor || '#000000';
    
    const instructionOverlay = document.createElement('div');
    instructionOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: white;
      padding: 20px;
      box-sizing: border-box;
    `;
    
    const closeButton = document.createElement('button');
    closeButton.style.cssText = `
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border: 2px solid white;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10001;
    `;
    closeButton.innerHTML = 'Ã—';
    
    const instructionText = document.createElement('div');
    instructionText.style.cssText = `
      text-align: center;
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 20px;
      max-width: 300px;
      line-height: 1.4;
    `;
    instructionText.textContent = 'Tap the color square below to choose a custom color';
    
    tempInput.style.cssText = `
      width: 80px;
      height: 80px;
      border: 3px solid white;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    `;

    const doneText = document.createElement('div');
    doneText.style.cssText = `
      text-align: center;
      font-size: 14px;
      opacity: 0.8;
      margin-top: 10px;
      display: none;
    `;
    doneText.textContent = 'Tap the Ã— button to close when done';
    
    instructionOverlay.appendChild(closeButton);
    instructionOverlay.appendChild(instructionText);
    instructionOverlay.appendChild(tempInput);
    instructionOverlay.appendChild(doneText);
    
    document.body.appendChild(instructionOverlay);
    
    tempInput.addEventListener('input', function(e) {
      const baseColor = e.target.value;
      const gradientActive = document.getElementById(target + '_gradient').value === 'true' ||
                             document.querySelector('.gradient-toggle-btn[data-target="' + target + '"]')?.classList.contains('active');
      
      setHiddenValue(target, baseColor, gradientActive);
      showCustomArea(target);
      updatePreview(target, baseColor, gradientActive);
      
      const picker = document.getElementById(target + '_picker');
      picker.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
      
      doneText.style.display = 'block';
      instructionText.textContent = 'Use the color picker above, then close when done';
    });

    function cleanup() {
      if (instructionOverlay && instructionOverlay.parentNode) {
        instructionOverlay.remove();
      }
    }

    closeButton.addEventListener('click', cleanup);
    
    setTimeout(() => {
      tempInput.focus();
      tempInput.click();
    }, 300);
    
    setTimeout(cleanup, 60000);
  }

  // Color option clicks
  document.querySelectorAll('.color-picker').forEach(picker => {
    picker.querySelectorAll('.color-option').forEach(option => {
      option.addEventListener('click', () => {
        picker.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
        option.classList.add('selected');
        const target = picker.id.replace('_picker', '');
        const baseColor = option.dataset.value;
        const gradientActive = document.getElementById(target + '_gradient').value === 'true' ||
                               document.querySelector('.gradient-toggle-btn[data-target="' + target + '"]')?.classList.contains('active');
        setHiddenValue(target, baseColor, gradientActive);
        showCustomArea(target);
        updatePreview(target, baseColor, gradientActive);
      });
    });
  });

  // Hidden color input changes
  document.querySelectorAll('.hidden-color-input').forEach(input => {
    input.addEventListener('input', (e) => {
      const target = e.target.dataset.target;
      const baseColor = e.target.value;
      const gradientActive = document.getElementById(target + '_gradient').value === 'true' ||
                             document.querySelector('.gradient-toggle-btn[data-target="' + target + '"]')?.classList.contains('active');
      setHiddenValue(target, baseColor, gradientActive);
      showCustomArea(target);
      updatePreview(target, baseColor, gradientActive);
      const picker = document.getElementById(target + '_picker');
      picker.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
    });
  });

  // FIXED: Gradient toggle with better debugging and validation
  document.querySelectorAll('.gradient-toggle-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault(); // Prevent form submission
      
      const target = btn.dataset.target;
      const mainInput = document.getElementById(target);
      const gradInput = document.getElementById(target + '_gradient');
      const currentlyOn = gradInput.value === 'true' || btn.classList.contains('active');
      
      console.log(`[${target}] Gradient toggle clicked. Currently on: ${currentlyOn}`);
      console.log(`[${target}] Current input value: ${mainInput.value}`);
      console.log(`[${target}] Current gradient flag: ${gradInput.value}`);
      
      // Get pure base color with extra validation
      let baseColor = getBaseColor(target, '#000000');
      
      // Extra validation: if we got a gradient somehow, extract again
      if (isGradientString(baseColor)) {
        console.log(`[${target}] WARNING: getBaseColor returned a gradient, re-extracting...`);
        baseColor = extractFirstHex(baseColor) || '#000000';
      }
      
      console.log(`[${target}] Using base color: ${baseColor}`);
      
      if (!currentlyOn) {
        // Turn gradient ON
        console.log(`[${target}] Turning gradient ON`);
        markGradientButton(target, true);
        setHiddenValue(target, baseColor, true);
        showCustomArea(target);
        updatePreview(target, baseColor, true);
      } else {
        // Turn gradient OFF
        console.log(`[${target}] Turning gradient OFF`);
        markGradientButton(target, false);
        setHiddenValue(target, baseColor, false);
        updatePreview(target, baseColor, false);
      }
      
      console.log(`[${target}] New input value: ${mainInput.value}`);
      console.log(`[${target}] New gradient flag: ${gradInput.value}`);
    });
  });

  // Custom color button logic
  document.querySelectorAll('.custom-color-btn').forEach(btn => {
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    
    btn.addEventListener('click', () => {
      const target = btn.dataset.target;
      showCustomArea(target);

      if (!isTouchDevice) {
        const tempInput = document.createElement('input');
        tempInput.type = 'color';
        tempInput.style.position = 'fixed';
        tempInput.style.top = '50vh';
        tempInput.style.left = '50vw';
        tempInput.style.transform = 'translate(-50%, -50%)';
        tempInput.style.opacity = '0';
        tempInput.style.pointerEvents = 'none';
        tempInput.style.zIndex = '10000';
        tempInput.style.width = '1px';
        tempInput.style.height = '1px';
        
        const currentColor = getBaseColor(target, '#000000');
        tempInput.value = currentColor;
        
        document.body.appendChild(tempInput);
        
        tempInput.addEventListener('input', function(e) {
          const baseColor = e.target.value;
          const gradientActive = document.getElementById(target + '_gradient').value === 'true' ||
                                 document.querySelector('.gradient-toggle-btn[data-target="' + target + '"]')?.classList.contains('active');
          
          setHiddenValue(target, baseColor, gradientActive);
          showCustomArea(target);
          updatePreview(target, baseColor, gradientActive);
          
          const picker = document.getElementById(target + '_picker');
          picker.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
        });

        tempInput.addEventListener('change', function() {
          setTimeout(() => tempInput.remove(), 100);
        });
        
        setTimeout(() => {
          tempInput.click();
          setTimeout(() => {
            if (tempInput.parentNode) tempInput.remove();
          }, 5000);
        }, 50);
        
      } else {
        const currentColor = getBaseColor(target, '#000000');
        triggerMobileColorPicker(target, currentColor);
      }
    });
  });

  // Default button logic
  document.querySelectorAll('.default-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.target;
      const mainInput = document.getElementById(target);
      
      // Clear stored base color
      delete mainInput.dataset.baseColor;
      
      setHiddenValue(target, '', false);
      const picker = document.getElementById(target + '_picker');
      picker.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
      const custom = document.getElementById(target + '_custom');
      if (custom) {
        custom.style.display = 'none';
        custom.classList.remove('active');
        const swatch = custom.querySelector('.color-preview-swatch');
        if (swatch) swatch.style.background = '';
      }
      const customBtn = picker.parentElement.querySelector('.custom-color-btn[data-target="' + target + '"]');
      if (customBtn) customBtn.classList.remove('active');
      markGradientButton(target, false);
    });
  });

  // CRITICAL FIX: Don't regenerate gradients that already exist
  ['button_color','card_background','small_card_bg','text_color'].forEach(target => {
    const mainInput = document.getElementById(target);
    const gradInput = document.getElementById(target + '_gradient');
    const val = mainInput.value;
    
    let baseColor = null;
    let gradientOn = false;
    
    // Determine the actual state
    if (isGradientString(val)) {
      // Current value is a gradient - DON'T recreate it, just extract base color for storage
      baseColor = extractFirstHex(val);
      gradientOn = true;
      // CRITICAL: Don't call setHiddenValue here - the gradient already exists
    } else if (val && val.startsWith('#')) {
      // Current value is a plain color
      baseColor = val;
      gradientOn = gradInput.value === 'true';
    } else {
      // No color set
      gradientOn = gradInput.value === 'true';
      if (gradientOn) baseColor = '#000000';
    }
    
    // Store the base color
    if (baseColor) {
      mainInput.dataset.baseColor = baseColor;
    }
    
    // Set the UI state WITHOUT regenerating values
    if (gradientOn) {
      markGradientButton(target, true);
      if (baseColor) {
        showCustomArea(target);
        updatePreview(target, baseColor, true);
        // ONLY set hidden value if we don't already have a gradient
        if (!isGradientString(val)) {
          setHiddenValue(target, baseColor, true);
        }
      }
    } else if (baseColor) {
      markGradientButton(target, false);
      showCustomArea(target);
      updatePreview(target, baseColor, false);
      // ONLY set hidden value if the current value is wrong
      if (mainInput.value !== baseColor) {
        setHiddenValue(target, baseColor, false);
      }
    }
  });

});
</script>


<script>
function setupAutocomplete(inputId, listId, formId) {
  const input = document.getElementById(inputId);
  const list = document.getElementById(listId);
  const form = document.getElementById(formId);

  if (!input || !list || !form) return;

  input.addEventListener('input', async () => {
    const query = input.value.trim();

    if (query.length < 2) {
      list.innerHTML = '';
      list.classList.add('hidden');
      return;
    }

    try {
      const res = await fetch(`/search/autocomplete?q=${encodeURIComponent(query)}`);
      const suggestions = await res.json();

      list.innerHTML = '';
      suggestions.forEach(name => {
        const li = document.createElement('li');
        li.textContent = name;
        li.addEventListener('click', () => {
          input.value = name;
          list.innerHTML = '';
          form.submit();
        });
        list.appendChild(li);
      });

      list.classList.remove('hidden');
    } catch (err) {
      console.error('Autocomplete fetch failed', err);
    }
  });

  document.addEventListener('click', (e) => {
    if (!input.contains(e.target) && !list.contains(e.target)) {
      list.innerHTML = '';
      list.classList.add('hidden');
    }
  });
}

setupAutocomplete('q', 'autocomplete-list', 'search-form');
setupAutocomplete('navbar-q', 'navbar-autocomplete-list', 'navbar-search-form');
</script>

</body>
</html>