<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"
    rel="stylesheet"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
  <div id="cropModal" class="hidden">
    <div class="crop-modal-content">
      <h3>Adjust your profile picture</h3>
      <div class="cropper-wrapper">
        <img id="cropperImage" alt="Crop Preview" />
      </div>
      <button type="button" id="cropSaveBtn">Save</button>
      <button type="button" id="cropCancelBtn">Cancel</button>
    </div>
  </div>

<!-- Analytics Modal -->
<div id="analyticsModal" class="analytics-modal hidden">
  <div class="analytics-modal-content">
    <div class="analytics-header">
      <h2 id="analyticsBusinessName">Business Analytics</h2>
      <button id="closeAnalytics" class="close-btn">&times;</button>
    </div>
    <div class="analytics-content">

      <h3 class="analytics-period-label">Week</h3>
      <div class="analytics-cards">
        <div class="analytics-card">
          <div class="analytics-card-icon">üëÅÔ∏è</div>
          <div class="analytics-card-content">
            <h3 id="weekViews">0</h3>
            <p>Profile Views</p>
          </div>
        </div>
        <div class="analytics-card">
          <div class="analytics-card-icon">üîç</div>
          <div class="analytics-card-content">
            <h3 id="weekSearches">0</h3>
            <p>Search Appearances</p>
          </div>
        </div>
      </div>

      <h3 class="analytics-period-label">Month</h3>
      <div class="analytics-cards">
        <div class="analytics-card">
          <div class="analytics-card-icon">üëÅÔ∏è</div>
          <div class="analytics-card-content">
            <h3 id="monthViews">0</h3>
            <p>Profile Views</p>
          </div>
        </div>
        <div class="analytics-card">
          <div class="analytics-card-icon">üîç</div>
          <div class="analytics-card-content">
            <h3 id="monthSearches">0</h3>
            <p>Search Appearances</p>
          </div>
        </div>
      </div>
        <div class="chart-container">
          <canvas id="analyticsChart"></canvas>
        </div>
        <div class="analytics-summary">
          <div class="summary-item">
            <span class="summary-label">All-Time Profile Views:</span>
            <span class="summary-value" id="allTimeViews">0</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">All-Time Search Appearances:</span>
            <span class="summary-value" id="allTimeSearches">0</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cropper.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const input = document.getElementById("profilePicInput");
      const modal = document.getElementById("cropModal");
      const image = document.getElementById("cropperImage");
      const saveBtn = document.getElementById("cropSaveBtn");
      const cancelBtn = document.getElementById("cropCancelBtn");

      let cropper;

      input.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (event) {
          image.src = event.target.result;
          modal.classList.remove("hidden");

          image.onload = () => {
            if (cropper) cropper.destroy();
            cropper = new Cropper(image, {
              aspectRatio: 1,
              viewMode: 1,
              background: false,
              dragMode: 'move',
              autoCropArea: 1,
            });
          };
        };
        reader.readAsDataURL(file);
      });

      saveBtn.addEventListener("click", () => {
        if (!cropper) return;

        cropper.getCroppedCanvas({
          width: 300,
          height: 300,
          imageSmoothingQuality: "high"
        }).toBlob((blob) => {
          const formData = new FormData();
          formData.append("profile_pic", blob, "cropped.png");

          fetch("{{ url_for('user.upload_profile_pic') }}", {
            method: "POST",
            body: formData
          })
            .then(res => {
              if (res.ok) return res.text();
              else throw new Error("Upload failed");
            })
            .then(() => {
              window.location.reload();
            })
            .catch((err) => {
              console.error(err);
              alert("Failed to upload image.");
            });

          modal.classList.add("hidden");
        });
      });

      cancelBtn.addEventListener("click", () => {
        modal.classList.add("hidden");
        if (cropper) cropper.destroy();
        cropper = null;
        input.value = ""; 
      });
    });
  </script>

  <nav class="navbar">
    <div class="nav-logo">
      Localate <img src="{{ url_for('static', filename='cat_logo.svg') }}" alt="Localate Logo" class="nav-icon" />
    </div>
    <form
      id="navbar-search-form"
      method="GET"
      action="{{ url_for('search.search') }}"
      class="navbar-search-form"
      role="search"
      autocomplete="off"
      style="max-width: 600px; min-width: 300px; position: relative; overflow: visible;"
    >
      <div class="search-input-wrapper" style="position: relative; width: 200%; margin-left: -30%;">
        <svg
          class="search-icon"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          aria-hidden="true"
          style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 1em; height: 1em; color: #888;"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1112 4.5a7.5 7.5 0 014.65 12.15z"
          />
        </svg>
        <input
          type="search"
          id="navbar-q"
          name="q"
          placeholder="Search for any business"
          value="{{ request.args.get('q', '') }}"
          aria-label="Search for a business or city"
          class="search-input"
          style="width: 75%; padding: 0.5em 0.5em 0.5em 2.2em; border-radius: 25px; border: none; background-color: #1e1e1e; color: #eee; font-size: 1rem;"
        />
        <ul
          id="navbar-autocomplete-list"
          class="autocomplete-suggestions hidden"
          style="top: 110%; left: 0; width: 75%;"
        ></ul>
      </div>
    </form>
    <input type="checkbox" id="nav-toggle" class="nav-toggle" />
    <ul class="nav-links">
      <li>
        <a href="{{ url_for('business.index') }}"
          ><img src="{{ url_for('static', filename='home_logo.svg') }}" alt="Home Icon" class="nav-icon-small" /> Home</a
        >
      </li>
      <li>
        <a href="{{ url_for('business.dashboard') }}"
          ><img src="{{ url_for('static', filename='dash_svg.svg') }}" alt="Dash Icon" name="dash-icon" class="nav-icon-small" /> Dashboard</a
        >
      <li><a href="{{ url_for('search.search') }}"><i class="fas fa-store nav-icon-small"></i> Browse</a></li>
      </li>
      <li>
        <a href="{{ url_for('auth.logout') }}"
          ><img src="{{ url_for('static', filename='logout.svg') }}" alt="Logout Icon" name="logout-icon" class="nav-icon-small" /> Logout</a
        >
      </li>
      <li><a href="{{ url_for('business.premium') }}"><i class="fas fa-crown nav-icon-small" style="color: #ffffff;"></i> Premium</a></li>
      <li>
      <a href="{{ url_for('business.support') }}" class="support-link" style="color: #ffffff;">
        <i class="fas fa-heart"></i> About Us
      </a>
    </li>
    </ul>
    <label for="nav-toggle" class="nav-toggle-label">
      <span></span>
    </label>
  </nav>

  <main class="dashboard-content">
    <section class="dashboard-card">
        <div class="card-label">Me</div>
      <div class="profile-section">
        <form method="POST" action="{{ url_for('user.upload_profile_pic') }}" enctype="multipart/form-data" id="profilePicForm">
          <label for="profilePicInput" class="profile-circle" aria-label="Upload Profile Picture">
            {% if current_user.profile_image_url %}
            <img src="{{ current_user.profile_image_url }}" alt="Your Profile" />
            {% else %}
            <span class="plus-only">+</span>
            {% endif %}
          </label>
          <input type="file" id="profilePicInput" name="profile_pic" accept="image/*" style="display: none;" />
        </form>
        {% if is_premium %}
      <span class="premium-badge" id="premiumBadge">
        <i class="fas fa-crown"></i>
        {% if ends_soon %}
          Premium Ends Soon
        {% else %}
          Premium Member
          <a href="javascript:void(0);" id="cancelSubscriptionBtn" class="cancel-subscription-link">
            <i class="fas fa-times-circle"></i> Cancel
          </a>
        {% endif %}
      </span>
      {% endif %}

        <div class="edit-profile-btn-container" class="action-buttons">
          <a href="{{ url_for('user.edit_profile') }}" class="edit-profile-btn">Manage Profile</a>
          <a href="{{ url_for('business.create_business') }}" class="action-btn">+ Create a Business</a>
        </div>
      </div>
    </section>

    <div class="main-boxes-container">
      <section class="business-section">
        <h2>My Appointments</h2>
        <div class="business-list">
          {% if appointments %}
          {% for appt in appointments %}
          <div class="business-card">
            <h3>{{ appt.business.name or "Unknown Business" }}</h3>
            <p>{{ appt.business.category or "Unknown Category" }}</p>

            {% set formatted_time = appt.time[:5] %}
            {% set hour = formatted_time.split(':')[0]|int %}
            {% set minute = formatted_time.split(':')[1] %}
            {% set ampm = 'AM' if hour < 12 else 'PM' %}
            {% set display_hour = hour if hour <= 12 else hour - 12 %}
            <p>Appointment: {{ appt.date }} at {{ '%02d' % display_hour }}:{{ minute }} {{ ampm }}</p>

            <p>Status:
              {% if appt.confirmed %}
              <span style="color: #4caf50; font-weight: bold;">Confirmed</span>
              {% else %}
              <span style="color: #f44336; font-weight: bold;">Pending</span>
              {% endif %}
            </p>
            <form action="{{ url_for('search.cancel_appointment') }}" method="POST" onsubmit="return confirmCancel();" style="margin-top: 1rem;">
            <input type="hidden" name="appointment_id" value="{{ appt.id }}">
            <button type="submit" class="cancel-btn">Cancel Appointment</button>
            </form>
          </div>
          {% endfor %}
          {% else %}
          <p>Nothing to see here yet...</p>
          {% endif %}
        </div>
      </section>

      <section class="your-business-section">
        <h2>My Businesses</h2>
        <div class="your-business-list">
          {% if businesses %}
          {% for biz in businesses %}
          <div class="business-card owner">
          <h3>
              {{ biz.name }}
              {% if current_user.is_premium %}
                <span class="dashboard-badge">
                  <i class="fa-solid fa-shield badge-background"></i>
                  <i class="fa-solid fa-cat badge-icon"></i>
                </span>
              {% endif %}
            </h3>
            <p>Category: {{ biz.category }}</p>
            <p>Location: {{ biz.city }}</p>
            <div class="business-actions">
              <a href="{{ url_for('business.view_business', business_id=biz.id) }}" class="edit-btn">Manage</a>
              <button class="analytics-btn" onclick="showAnalytics({{ biz.id }}, '{{ biz.name }}')">
                <i class="fas fa-chart-bar"></i> Analytics
              </button>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <p>Nothing to see here yet...</p>
          {% endif %}
        </div>
      </section>
    </div>
  </main>

  <!-- Cancel Subscription Confirmation Modal -->
  <div id="cancelSubscriptionModal" class="subscription-modal hidden">
    <div class="subscription-modal-content">
      <div class="subscription-modal-header">
        <h3>Cancel Premium Subscription</h3>
        <button id="closeCancelModal" class="close-btn">&times;</button>
      </div>
      <div class="subscription-modal-body">
        <div class="warning-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <p>Are you sure you want to cancel your premium subscription?</p>
        <div class="cancel-info">
          <p><strong>What happens next:</strong></p>
          <ul>
            <li>Your subscription will remain active until the end of your current billing period</li>
            <li>You'll continue to have premium features until then</li>
            <li>No further charges will be made</li>
            <li>You can resubscribe at any time</li>
          </ul>
        </div>
      </div>
      <div class="subscription-modal-actions">
        <button id="confirmCancelSubscription" class="confirm-cancel-btn">
          <i class="fas fa-times"></i>
          Yes, Cancel Subscription
        </button>
        <button id="keepSubscription" class="keep-subscription-btn">
          <i class="fas fa-crown"></i>
          Keep Premium
        </button>
      </div>
    </div>
  </div>

  <script>
  function confirmCancel() {
    return confirm("Are you sure you want to cancel this appointment?");
  }

  let analyticsChart = null;

  function showAnalytics(businessId, businessName) {
    const modal = document.getElementById('analyticsModal');
    const businessNameEl = document.getElementById('analyticsBusinessName');
    
    businessNameEl.textContent = `${businessName} - Analytics`;
    modal.classList.remove('hidden');
    
    // Show loading state
    document.getElementById('weekViews').textContent = '...';
    document.getElementById('weekSearches').textContent = '...';
    document.getElementById('monthViews').textContent = '...';
    document.getElementById('monthSearches').textContent = '...';
    document.getElementById('allTimeViews').textContent = '...';
    document.getElementById('allTimeSearches').textContent = '...';
    
    // Fetch analytics data
    fetch(`/search/business/${businessId}/analytics`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update cards
          document.getElementById('weekViews').textContent = data.week.profile_views;
          document.getElementById('weekSearches').textContent = data.week.search_appearances;
          document.getElementById('monthViews').textContent = data.month.profile_views;
          document.getElementById('monthSearches').textContent = data.month.search_appearances;
          document.getElementById('allTimeViews').textContent = data.all_time.profile_views;
          document.getElementById('allTimeSearches').textContent = data.all_time.search_appearances;
          
          // Update chart
          updateAnalyticsChart(data);
        } else {
          console.error('Failed to fetch analytics:', data.error);
          alert('Failed to load analytics data');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error loading analytics data');
      });
  }

  function updateAnalyticsChart(data) {
    const ctx = document.getElementById('analyticsChart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (analyticsChart) {
      analyticsChart.destroy();
    }
    
    analyticsChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['7 Days', '30 Days', 'All Time'],
        datasets: [
            {
              label: 'Profile Views',
              data: [data.week.profile_views, data.month.profile_views, data.all_time.profile_views],
              backgroundColor: 'rgba(56, 189, 248, 0.8)', 
              borderColor: 'rgba(14, 165, 233, 1)',       
              borderWidth: 2,
              borderRadius: 8
            },
            {
              label: 'Search Appearances',
              data: [data.week.search_appearances, data.month.search_appearances, data.all_time.search_appearances],
              backgroundColor: 'rgba(134, 239, 172, 0.8)', 
              borderColor: 'rgba(22, 163, 74, 1)',         
              borderWidth: 2,
              borderRadius: 8
            }
          ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: '#e5e5e5',
              font: {
                family: 'Inter, sans-serif',
                size: 12
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              color: '#b0b0b0',
              font: {
                family: 'Inter, sans-serif'
              }
            },
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            }
          },
          x: {
            ticks: {
              color: '#b0b0b0',
              font: {
                family: 'Inter, sans-serif'
              }
            },
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            }
          }
        }
      }
    });
  }

  document.getElementById('closeAnalytics').addEventListener('click', () => {
    document.getElementById('analyticsModal').classList.add('hidden');
  });

  document.getElementById('analyticsModal').addEventListener('click', (e) => {
    if (e.target.id === 'analyticsModal') {
      document.getElementById('analyticsModal').classList.add('hidden');
    }
  });

document.addEventListener('DOMContentLoaded', () => {
  const cancelBtn = document.getElementById('cancelSubscriptionBtn');
  const modal = document.getElementById('cancelSubscriptionModal');
  const closeBtn = document.getElementById('closeCancelModal');
  const confirmBtn = document.getElementById('confirmCancelSubscription');
  const keepBtn = document.getElementById('keepSubscription');

  // Show modal
  cancelBtn?.addEventListener('click', () => modal.classList.remove('hidden'));

  // Close modal
  closeBtn?.addEventListener('click', () => modal.classList.add('hidden'));
  keepBtn?.addEventListener('click', () => modal.classList.add('hidden'));

  // Submit cancel form
  confirmBtn?.addEventListener('click', () => {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("business.cancel_subscription") }}';
    document.body.appendChild(form);
    form.submit();
    modal.classList.add('hidden');
  });

  // Close modal by clicking outside
  modal?.addEventListener('click', e => {
    if (e.target.id === 'cancelSubscriptionModal') modal.classList.add('hidden');
  });
});
</script>

  <script>
    function setupAutocomplete(inputId, listId, formId) {
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      const form = document.getElementById(formId);

      if (!input || !list || !form) return;

      input.addEventListener("input", async () => {
        const query = input.value.trim();

        if (query.length < 2) {
          list.innerHTML = "";
          list.classList.add("hidden");
          return;
        }

        try {
          const res = await fetch(`/search/autocomplete?q=${encodeURIComponent(query)}`);
          const suggestions = await res.json();

          list.innerHTML = "";
          suggestions.forEach((name) => {
            const li = document.createElement("li");
            li.textContent = name;
            li.addEventListener("click", () => {
              input.value = name;
              list.innerHTML = "";
              form.submit();
            });
            list.appendChild(li);
          });

          list.classList.remove("hidden");
        } catch (err) {
          console.error("Autocomplete fetch failed", err);
        }
      });

      document.addEventListener("click", (e) => {
        if (!input.contains(e.target) && !list.contains(e.target)) {
          list.innerHTML = "";
          list.classList.add("hidden");
        }
      });
    }

    setupAutocomplete("q", "autocomplete-list", "search-form");
    setupAutocomplete("navbar-q", "navbar-autocomplete-list", "navbar-search-form");
  </script>
</body>
<div id="cookie-banner">
  <p>We use cookies to improve your experience on our site. By using our site, you consent to cookies.</p>
  <button id="accept-cookies">Got it</button>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const banner = document.getElementById("cookie-banner");
    const acceptBtn = document.getElementById("accept-cookies");

    if (!localStorage.getItem("cookiesAccepted")) {
      setTimeout(() => banner.classList.add("show"), 500);
    }

    acceptBtn.addEventListener("click", () => {
      localStorage.setItem("cookiesAccepted", "true");
      banner.classList.remove("show");
    });
  });
</script>

</html>